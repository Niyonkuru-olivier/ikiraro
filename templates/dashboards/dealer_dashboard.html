<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Agro-Dealer Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='profile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='weather-widget.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='mobile-responsive.css') }}">
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
      color: #333;
    }

    header {
      background: linear-gradient(135deg, #022b16, #022b16);
      color: white;
      padding: 24px;
      text-align: left;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .container {
      padding: 25px;
      max-width: 950px;
      margin: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Accordion Buttons */
    .accordion-container {
      width: 100%;
    }

    .accordion {
      background-color: #022b16;
      color: #fff;
      cursor: pointer;
      padding: 16px 20px;
      width: 100%;
      text-align: left;
      border: none;
      outline: none;
      transition: all 0.3s ease;
      border-radius: 10px;
      font-size: 17px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .accordion::after {
      content: '\25BC';
      font-size: 14px;
      transition: transform 0.3s;
    }

    .accordion.active::after {
      transform: rotate(-180deg);
    }

    .accordion.active,
    .accordion:hover {
      background-color: #034d2e;
    }

    .panel {
      display: none;
      padding: 20px;
      background-color: white;
      border: 1px solid #e0e0e0;
      border-top: none;
      border-radius: 0 0 10px 10px;
      animation: fadeIn 0.3s ease;
      margin-top: -5px;
    }

    .panel.show {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 10px 12px;
      text-align: left;
    }

    th {
      background: #022b16;
      color: white;
      font-weight: 500;
    }

    td {
      background: #fafafa;
    }

    tr:nth-child(even) td {
      background: #f0fdfb;
    }

    /* Buttons */
    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-primary { background: #022b16; color: white; }
    .btn-primary:hover { background: #034d2e; }
    .btn-success { background: #16a34a; color: white; }
    .btn-success:hover { background: #15803d; }
    .btn-danger { background: #dc2626; color: white; }
    .btn-danger:hover { background: #b91c1c; }
    .btn-info { background: #0ea5e9; color: white; }
    .btn-info:hover { background: #0284c7; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-warning:hover { background: #d97706; }
    .btn-purple { background: #7c3aed; color: white; }
    .btn-purple:hover { background: #6d28d9; }
    
    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-approved { background: #d1fae5; color: #065f46; }
    .status-rejected { background: #fee2e2; color: #991b1b; }
    .status-delivered { background: #dbeafe; color: #1e40af; }

    /* Farmer details */
    .farmer-details {
      margin-top: 6px;
      padding: 8px;
      background: #f8fafc;
      border-radius: 6px;
      font-size: 12px;
      color: #475569;
      border-left: 3px solid #022b16;
    }
    .farmer-details strong { color: #0f172a; }

    /* Forms */
    .form-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      align-items: center;
    }
    .form-row input, .form-row textarea {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    .form-row input:focus, .form-row textarea:focus {
      outline: none;
      border-color: #022b16;
      box-shadow: 0 0 0 3px rgba(2, 43, 22, 0.1);
    }

    /* Inline form for table */
    .inline-form {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .inline-form input {
      width: 70px;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }

    /* Published announcements */
    .published-list {
      margin-top: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .published-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 14px 16px;
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid #7c3aed;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .published-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.15);
    }
    .published-item.expired {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border-left-color: #dc2626;
      opacity: 0.7;
    }
    .published-item .info { flex: 1; margin-right: 12px; }
    .published-item .title { font-weight: 600; color: #022b16; font-size: 15px; margin-bottom: 4px; }
    .published-item .meta { font-size: 12px; color: #666; line-height: 1.5; }

    /* Announcement form */
    .announcement-form {
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #86efac;
    }

    /* Toast */
    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 12px 18px;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .25s ease, transform .25s ease;
      z-index: 9999;
    }
    .toast.show { opacity: 1; transform: translateY(0); }

    .muted { color: #666; font-size: 13px; }
    .section-desc { color: #666; font-size: 13px; margin-bottom: 12px; }

    @media (max-width: 768px) {
      .container { padding: 15px; }
      .accordion { font-size: 15px; padding: 14px 16px; }
      .panel { padding: 15px; }
      .form-row { flex-direction: column; }
      .form-row input, .form-row textarea { width: 100%; }
    }
  </style>
</head>
<body>
  <header class="dashboard-hero">
    <div class="dashboard-hero__heading">
      <p>Agro-Dealer Operations</p>
      <h1>Welcome, {{ user.full_name }} (Agro-Dealer)</h1>
    </div>
    <div class="dashboard-hero__profile">
      {% include 'partials/profile_section.html' %}
    </div>
  </header>

  <div class="container">
    <!-- Weather Widget (unchanged position) -->
    {% with weather=weather, variant='compact', theme='light', refresh_seconds=600 %}
      {% include 'partials/weather_widget.html' %}
    {% endwith %}

    <!-- Inventory Section -->
    <div class="accordion-container">
      <button class="accordion">üì¶ Inventory Management</button>
      <div class="panel">
        <p class="section-desc">Manage your product inventory. Farmers can see and order from your available stock.</p>
        
        <form method="post" action="{{ url_for('dealer_inventory_create') }}" class="form-row" style="background:#f8fafc; padding:12px; border-radius:8px; margin-bottom:16px;">
          <input type="text" name="product_name" placeholder="Product name *" required style="flex:2;" />
          <input type="number" name="stock" placeholder="Stock" min="0" value="0" style="width:100px;" />
          <input type="text" name="unit" placeholder="Unit (kg)" value="kg" style="width:100px;" />
          <input type="text" name="price" placeholder="Price" style="width:120px;" />
          <button class="btn btn-primary" type="submit">‚ûï Add Item</button>
        </form>

        {% if inventory %}
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Product</th>
                <th>Stock</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Last Updated</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="inventory-tbody">
              {% for item in inventory %}
              <tr data-inv-id="{{ item.id }}">
                <td>{{ item.id }}</td>
                <td>{{ item.product_name }}</td>
                <td class="stock-cell">{{ item.stock }}</td>
                <td>{{ item.unit }}</td>
                <td>{{ item.price if item.price is not none else '-' }}</td>
                <td>{{ item.last_updated.strftime('%Y-%m-%d %H:%M') if item.last_updated else '-' }}</td>
                <td>
                  <form class="inline-form" method="post" action="{{ url_for('dealer_inventory_update', inv_id=item.id) }}">
                    <input type="number" name="stock" value="{{ item.stock }}" min="0" />
                    <input type="text" name="price" placeholder="price" value="{{ item.price if item.price is not none else '' }}" style="width:60px;" />
                    <button class="btn btn-primary" type="submit" style="padding:6px 10px;">Update</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="muted">No inventory items yet. Add your first product above!</p>
        {% endif %}
      </div>
      </div>

    <!-- Farmer Orders Section -->
    <div class="accordion-container">
      <button class="accordion">üõí Farmer Orders</button>
      <div class="panel">
        <p class="section-desc">Orders from farmers for your products. Approve, reject, or change decisions on orders.</p>
        
        <table>
          <thead>
            <tr>
              <th>Farmer</th>
              <th>Product</th>
              <th>Quantity</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="farmer-orders-tbody">
            <!-- Will be filled by JS -->
          </tbody>
        </table>
        <p id="no-orders-msg" class="muted" style="margin-top:12px;">No orders from farmers yet.</p>
      </div>
    </div>

    <!-- Subsidies & Programs Section -->
    <div class="accordion-container">
      <button class="accordion">üì¢ Subsidies & Programs for Farmers</button>
      <div class="panel">
        <p class="section-desc">Create announcements that will be visible to all farmers. They will see your contact details.</p>
        
        <form id="publish-subsidy-form" class="announcement-form">
          <div class="form-row">
            <input type="text" id="subsidy-title" placeholder="Title (e.g., Fertilizer Discount Program) *" required style="flex:2;" />
            <input type="text" id="subsidy-commodity" placeholder="Commodity (e.g., Maize)" style="flex:1;" />
          </div>
          <div class="form-row">
            <textarea id="subsidy-description" placeholder="Description - explain the program details, eligibility, etc." style="flex:1; min-height:60px; resize:vertical;"></textarea>
        </div>
          <div class="form-row">
            <input type="number" id="subsidy-discount" placeholder="Discount %" min="0" max="100" style="width:100px;" />
          <label style="font-size:13px; color:#666;">Valid From:</label>
            <input type="date" id="subsidy-valid-from" />
          <label style="font-size:13px; color:#666;">To:</label>
            <input type="date" id="subsidy-valid-to" />
            <button type="submit" class="btn btn-purple" id="publish-btn" style="margin-left:auto;">üì£ Publish to All Farmers</button>
        </div>
      </form>
      </div>
    </div>

    <!-- Published Announcements Section -->
    <div class="accordion-container">
      <button class="accordion">üìã Your Published Announcements</button>
      <div class="panel">
        <p class="section-desc">These announcements are visible to all farmers. Expired ones are automatically hidden from farmers.</p>
        
        <div id="published-list" class="published-list">
          <!-- Will be filled by JS -->
        </div>
        <p id="no-published-msg" class="muted">No announcements published yet.</p>
      </div>
    </div>
  </div>

  <script>
    // Dealer info
    const DEALER_INFO = {
      id: {{ user.id|tojson }},
      name: {{ user.full_name|tojson }},
      email: {{ (user.email or "")|tojson }},
      phone: {{ (user.phone or "")|tojson }}
    };
    console.log('Dealer Info:', DEALER_INFO);

    // ========== ACCORDION FUNCTIONALITY ==========
    const accordions = document.querySelectorAll('.accordion');
    accordions.forEach(acc => {
      acc.addEventListener('click', function() {
        // Close all other panels
        accordions.forEach(other => {
          if (other !== this) {
            other.classList.remove('active');
            other.nextElementSibling.classList.remove('show');
          }
        });
        // Toggle this panel
        this.classList.toggle('active');
        const panel = this.nextElementSibling;
        panel.classList.toggle('show');
      });
    });

    // ========== TOAST ==========
    function showToast(msg) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      document.body.appendChild(t);
      requestAnimationFrame(() => t.classList.add('show'));
      setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 250); }, 2500);
    }

    // ========== FARMER ORDERS (Database API) ==========
    async function fetchFarmerOrders() {
      try {
        const response = await fetch('/api/dealer-orders');
        if (response.ok) {
          return await response.json();
        }
        return [];
      } catch (e) {
        console.error('Error fetching farmer orders:', e);
        return [];
      }
    }

    async function updateOrderAction(orderId, action) {
      try {
        const response = await fetch(`/api/dealer-orders/${orderId}/action`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: action })
        });
        const data = await response.json();
        return response.ok ? { success: true } : { success: false, error: data.error };
      } catch (e) {
        console.error('Error updating order:', e);
        return { success: false, error: e.message };
      }
    }

    async function renderFarmerOrders() {
      const tbody = document.getElementById('farmer-orders-tbody');
      const noMsg = document.getElementById('no-orders-msg');
      if (!tbody) return;
      
      const orders = await fetchFarmerOrders();
      console.log('Fetched farmer orders:', orders);
      
      tbody.innerHTML = '';

      if (orders.length === 0) {
        if (noMsg) noMsg.style.display = 'block';
        return;
      }
      if (noMsg) noMsg.style.display = 'none';
      
      orders.forEach(o => {
        const tr = document.createElement('tr');
        const statusLower = (o.status || '').toLowerCase();
        
        let statusHtml = '';
        let actionsHtml = '';
        
        if (statusLower === 'pending') {
          statusHtml = `<span class="status-badge status-pending">Pending</span>`;
          actionsHtml = `
            <button class="btn btn-success approve-btn" data-id="${o.id}">‚úì Approve</button>
            <button class="btn btn-danger reject-btn" data-id="${o.id}" style="margin-left:4px;">‚úó Reject</button>
          `;
        } else if (statusLower === 'approved') {
          statusHtml = `
            <span class="status-badge status-approved">‚úì Approved</span>
            <div class="farmer-details">
              <strong>Farmer:</strong> ${o.farmer_name || 'N/A'}<br>
              <strong>Email:</strong> ${o.farmer_email || 'N/A'}<br>
              <strong>Phone:</strong> ${o.farmer_phone || 'N/A'}
            </div>
          `;
          actionsHtml = `
            <button class="btn btn-info deliver-btn" data-id="${o.id}">üì¶ Mark Delivered</button>
            <button class="btn btn-warning change-btn" data-id="${o.id}" data-action="reject" style="margin-left:4px;">Change to Reject</button>
          `;
        } else if (statusLower === 'rejected') {
          statusHtml = `
            <span class="status-badge status-rejected">‚úó Rejected</span>
            <div class="farmer-details">
              <strong>Farmer:</strong> ${o.farmer_name || 'N/A'}<br>
              <strong>Email:</strong> ${o.farmer_email || 'N/A'}<br>
              <strong>Phone:</strong> ${o.farmer_phone || 'N/A'}
            </div>
          `;
          actionsHtml = `
            <button class="btn btn-warning change-btn" data-id="${o.id}" data-action="approve">Change to Approve</button>
          `;
        } else if (statusLower === 'delivered') {
          statusHtml = `<span class="status-badge status-delivered">üì¶ Delivered</span>`;
          actionsHtml = `<span class="muted">Completed</span>`;
        }
        
        tr.innerHTML = `
          <td>${o.farmer_name || '-'}</td>
          <td>${o.product_name || '-'}</td>
          <td>${o.quantity || '-'} ${o.unit || ''}</td>
          <td>${statusHtml}</td>
          <td>${actionsHtml}</td>
        `;
        tbody.appendChild(tr);
      });

      // Attach event handlers
      attachOrderHandlers();
    }

    function attachOrderHandlers() {
      const tbody = document.getElementById('farmer-orders-tbody');

      tbody.querySelectorAll('.approve-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const id = this.getAttribute('data-id');
          this.disabled = true;
          this.textContent = 'Processing...';
          
          const result = await updateOrderAction(id, 'approve');
          if (result.success) {
            await renderFarmerOrders();
            showToast('Order approved! Stock updated.');
          } else {
            alert('Error: ' + (result.error || 'Could not approve'));
            this.disabled = false;
            this.textContent = '‚úì Approve';
          }
        });
      });

      tbody.querySelectorAll('.reject-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const id = this.getAttribute('data-id');
          this.disabled = true;
          this.textContent = 'Processing...';
          
          const result = await updateOrderAction(id, 'reject');
          if (result.success) {
            await renderFarmerOrders();
            showToast('Order rejected.');
          } else {
            alert('Error: ' + (result.error || 'Could not reject'));
            this.disabled = false;
            this.textContent = '‚úó Reject';
          }
        });
      });

      tbody.querySelectorAll('.deliver-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const id = this.getAttribute('data-id');
          this.disabled = true;
          this.textContent = 'Processing...';
          
          const result = await updateOrderAction(id, 'deliver');
          if (result.success) {
            await renderFarmerOrders();
            showToast('Order marked as delivered.');
          } else {
            alert('Error: ' + (result.error || 'Could not update'));
            this.disabled = false;
            this.textContent = 'üì¶ Mark Delivered';
          }
        });
      });

      tbody.querySelectorAll('.change-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const id = this.getAttribute('data-id');
          const action = this.getAttribute('data-action');
          this.disabled = true;
          this.textContent = 'Processing...';
          
          const result = await updateOrderAction(id, action);
          if (result.success) {
            await renderFarmerOrders();
            showToast('Decision changed successfully!');
          } else {
            alert('Error: ' + (result.error || 'Could not change decision'));
            this.disabled = false;
            this.textContent = action === 'approve' ? 'Change to Approve' : 'Change to Reject';
          }
        });
      });
    }

    // ========== ANNOUNCEMENTS (Database API) ==========
    async function fetchAnnouncements() {
      try {
        const response = await fetch('/api/announcements');
        if (response.ok) {
          return await response.json();
        }
        return [];
      } catch (e) {
        console.error('Error fetching announcements:', e);
        return [];
      }
    }

    async function createAnnouncement(data) {
      try {
        const response = await fetch('/api/announcements', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        return response.ok ? { success: true } : { success: false, error: result.error };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    async function deleteAnnouncementAPI(id) {
      try {
        const response = await fetch(`/api/announcements/${id}`, { method: 'DELETE' });
        return response.ok;
      } catch (e) {
        return false;
      }
    }

    async function renderPublishedAnnouncements() {
      const container = document.getElementById('published-list');
      const noMsg = document.getElementById('no-published-msg');
      if (!container) return;

      const announcements = await fetchAnnouncements();
      container.innerHTML = '';

      if (announcements.length === 0) {
        if (noMsg) noMsg.style.display = 'block';
        return;
      }
      if (noMsg) noMsg.style.display = 'none';

      const today = new Date().toISOString().split('T')[0];

      announcements.forEach(a => {
        const isExpired = a.valid_to && a.valid_to < today;
        const div = document.createElement('div');
        div.className = 'published-item' + (isExpired ? ' expired' : '');
        div.innerHTML = `
          <div class="info">
            <div class="title">${a.title} ${isExpired ? '<span style="color:#dc2626; font-size:11px;">(Expired)</span>' : '<span style="color:#16a34a; font-size:11px;">(Active)</span>'}</div>
            <div class="meta">
              ${a.commodity ? 'üåæ ' + a.commodity + ' ‚Ä¢ ' : ''}
              ${a.discount_percent ? 'üè∑Ô∏è ' + a.discount_percent + '% discount ‚Ä¢ ' : ''}
              ${a.valid_from ? 'üìÖ From ' + a.valid_from : ''} ${a.valid_to ? ' to ' + a.valid_to : ''}
            </div>
            ${a.description ? '<div class="meta" style="margin-top:4px;">' + a.description.substring(0, 100) + (a.description.length > 100 ? '...' : '') + '</div>' : ''}
          </div>
          <div style="display:flex; gap:6px; flex-direction:column;">
            <button class="btn btn-info edit-announcement-btn" data-id="${a.id}" data-title="${a.title}" data-description="${a.description || ''}" data-commodity="${a.commodity || ''}" data-discount="${a.discount_percent || ''}" data-from="${a.valid_from || ''}" data-to="${a.valid_to || ''}" style="padding:6px 10px; font-size:12px;">‚úèÔ∏è Edit</button>
            <button class="btn btn-danger delete-announcement-btn" data-id="${a.id}" style="padding:6px 10px; font-size:12px;">üóëÔ∏è Remove</button>
          </div>
        `;
        container.appendChild(div);
      });

      // Attach edit handlers
      container.querySelectorAll('.edit-announcement-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const title = this.getAttribute('data-title');
          const description = this.getAttribute('data-description');
          const commodity = this.getAttribute('data-commodity');
          const discount = this.getAttribute('data-discount');
          const validFrom = this.getAttribute('data-from');
          const validTo = this.getAttribute('data-to');
          
          openEditModal(id, title, description, commodity, discount, validFrom, validTo);
        });
      });

      // Attach delete handlers
      container.querySelectorAll('.delete-announcement-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const id = this.getAttribute('data-id');
          if (!confirm('Delete this announcement? It will be removed from all farmers.')) return;
          
          this.disabled = true;
          this.textContent = 'Removing...';
          
          const success = await deleteAnnouncementAPI(id);
          if (success) {
            await renderPublishedAnnouncements();
            showToast('Announcement removed.');
          } else {
            alert('Failed to delete');
            this.disabled = false;
            this.textContent = 'üóëÔ∏è Remove';
          }
        });
      });
    }

    // ========== EDIT MODAL ==========
    function openEditModal(id, title, description, commodity, discount, validFrom, validTo) {
      // Remove existing modal if any
      const existingModal = document.getElementById('edit-modal');
      if (existingModal) existingModal.remove();

      const modal = document.createElement('div');
      modal.id = 'edit-modal';
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;';
      modal.innerHTML = `
        <div style="background:white;padding:24px;border-radius:12px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;">
          <h3 style="margin:0 0 16px;color:#022b16;">‚úèÔ∏è Edit Announcement</h3>
          <form id="edit-announcement-form">
            <input type="hidden" id="edit-id" value="${id}" />
            <div style="margin-bottom:12px;">
              <label style="font-size:13px;color:#666;display:block;margin-bottom:4px;">Title *</label>
              <input type="text" id="edit-title" value="${title}" required style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;" />
            </div>
            <div style="margin-bottom:12px;">
              <label style="font-size:13px;color:#666;display:block;margin-bottom:4px;">Description</label>
              <textarea id="edit-description" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;min-height:80px;resize:vertical;box-sizing:border-box;">${description}</textarea>
            </div>
            <div style="display:flex;gap:12px;margin-bottom:12px;">
              <div style="flex:1;">
                <label style="font-size:13px;color:#666;display:block;margin-bottom:4px;">Commodity</label>
                <input type="text" id="edit-commodity" value="${commodity}" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;" />
              </div>
              <div style="width:100px;">
                <label style="font-size:13px;color:#666;display:block;margin-bottom:4px;">Discount %</label>
                <input type="number" id="edit-discount" value="${discount}" min="0" max="100" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;" />
              </div>
            </div>
            <div style="display:flex;gap:12px;margin-bottom:16px;">
              <div style="flex:1;">
                <label style="font-size:13px;color:#666;display:block;margin-bottom:4px;">Valid From</label>
                <input type="date" id="edit-valid-from" value="${validFrom}" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;" />
              </div>
              <div style="flex:1;">
                <label style="font-size:13px;color:#666;display:block;margin-bottom:4px;">Valid To</label>
                <input type="date" id="edit-valid-to" value="${validTo}" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;" />
              </div>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
              <button type="button" id="cancel-edit-btn" class="btn" style="background:#64748b;">Cancel</button>
              <button type="submit" id="save-edit-btn" class="btn btn-primary">üíæ Save Changes</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      // Close on cancel
      document.getElementById('cancel-edit-btn').addEventListener('click', () => modal.remove());

      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      // Handle save
      document.getElementById('edit-announcement-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const saveBtn = document.getElementById('save-edit-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const updateData = {
          title: document.getElementById('edit-title').value.trim(),
          description: document.getElementById('edit-description').value.trim(),
          commodity: document.getElementById('edit-commodity').value.trim(),
          discount_percent: document.getElementById('edit-discount').value || 0,
          valid_from: document.getElementById('edit-valid-from').value,
          valid_to: document.getElementById('edit-valid-to').value
        };

        const success = await updateAnnouncementAPI(id, updateData);
        if (success) {
          modal.remove();
          await renderPublishedAnnouncements();
          showToast('Announcement updated successfully!');
        } else {
          alert('Failed to update announcement');
          saveBtn.disabled = false;
          saveBtn.textContent = 'üíæ Save Changes';
        }
      });
    }

    async function updateAnnouncementAPI(id, data) {
      try {
        const response = await fetch(`/api/announcements/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        return response.ok;
      } catch (e) {
        console.error('Error updating announcement:', e);
        return false;
      }
    }

    // Handle publish form
    document.getElementById('publish-subsidy-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const title = document.getElementById('subsidy-title').value.trim();
      if (!title) {
        alert('Title is required');
        return;
      }

      const publishBtn = document.getElementById('publish-btn');
      publishBtn.disabled = true;
      publishBtn.textContent = 'Publishing...';

      const data = {
        title: title,
        description: document.getElementById('subsidy-description').value.trim(),
        commodity: document.getElementById('subsidy-commodity').value.trim(),
        discount_percent: document.getElementById('subsidy-discount').value || 0,
        valid_from: document.getElementById('subsidy-valid-from').value,
        valid_to: document.getElementById('subsidy-valid-to').value
      };

      const result = await createAnnouncement(data);

      if (result.success) {
        document.getElementById('subsidy-title').value = '';
        document.getElementById('subsidy-description').value = '';
        document.getElementById('subsidy-commodity').value = '';
        document.getElementById('subsidy-discount').value = '';
        document.getElementById('subsidy-valid-from').value = '';
        document.getElementById('subsidy-valid-to').value = '';

        await renderPublishedAnnouncements();
        showToast('üéâ Announcement published to all farmers!');
      } else {
        alert('Error: ' + (result.error || 'Could not publish'));
      }

      publishBtn.disabled = false;
      publishBtn.textContent = 'üì£ Publish to All Farmers';
    });

    // ========== INITIAL RENDER ==========
    renderFarmerOrders();
    renderPublishedAnnouncements();

    // Refresh periodically
    setInterval(renderFarmerOrders, 30000);
    setInterval(renderPublishedAnnouncements, 60000);
  </script>
  <script src="{{ url_for('static', filename='weather.js') }}"></script>
</body>
</html>
