<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Farmer Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='profile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='weather-widget.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='mobile-responsive.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f5f7fa;
  margin: 0;
  padding: 0;
  color: #333;
}

header {
  background: linear-gradient(135deg, #022b16, #022b16);
  color: white;
  padding: 24px;
  text-align: left;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.container {
  padding: 25px;
      max-width: 900px;
  margin: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
}

/* Accordion Buttons */
    .accordion-container {
      width: 100%;
    }

.accordion {
  background-color: #022b16;
  color: #fff;
  cursor: pointer;
      padding: 16px 20px;
  width: 100%;
  text-align: left;
  border: none;
  outline: none;
  transition: all 0.3s ease;
      border-radius: 10px;
  font-size: 17px;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.accordion::after {
  content: '\25BC';
  font-size: 14px;
  transition: transform 0.3s;
}

.accordion.active::after {
  transform: rotate(-180deg);
}

.accordion.active,
.accordion:hover {
      background-color: #034d2e;
}

.panel {
      display: none;
      padding: 20px;
  background-color: white;
      border: 1px solid #e0e0e0;
      border-top: none;
      border-radius: 0 0 10px 10px;
      animation: fadeIn 0.3s ease;
      margin-top: -5px;
    }

    .panel.show {
      display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Tables */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  font-size: 14px;
}

th, td {
  border: 1px solid #e0e0e0;
  padding: 10px 12px;
  text-align: left;
}

th {
  background: #022b16;
  color: white;
  font-weight: 500;
}

td {
  background: #fafafa;
}

tr:nth-child(even) td {
  background: #f0fdfb;
}

/* Farming Tips */
.tip-section {
  margin-bottom: 20px;
}

.tip-section h3 {
  margin-top: 0;
  color: #022b16;
  font-size: 16px;
}

.tip-section ul {
  padding-left: 18px;
  margin: 6px 0;
}

.tip-section li {
  margin-bottom: 6px;
  line-height: 1.4;
}

/* Buttons & Forms */
form input, form button {
  border-radius: 6px;
  border: 1px solid #ccc;
  padding: 8px 10px;
  font-size: 14px;
}

form button {
  background: #022b16;
  color: white;
  border: none;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.3s;
}

form button:hover {
      background: #034d2e;
    }

    /* Action buttons */
    .approve-btn, .reject-btn, .change-decision, .delete-decision {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }
    .approve-btn { background: #16a34a; color: white; }
    .approve-btn:hover { background: #15803d; }
    .reject-btn { background: #dc2626; color: white; }
    .reject-btn:hover { background: #b91c1c; }
    .change-decision { background: #0ea5e9; color: white; }
    .change-decision:hover { background: #0284c7; }
    .delete-decision { background: #64748b; color: white; }
    .delete-decision:hover { background: #475569; }

    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-approved { background: #d1fae5; color: #065f46; }
    .status-rejected { background: #fee2e2; color: #991b1b; }
    .status-delivered { background: #dbeafe; color: #1e40af; }

    /* Dealer details in status */
    .dealer-details {
      margin-top: 6px;
      padding: 8px;
      background: #f8fafc;
      border-radius: 6px;
      font-size: 12px;
      color: #475569;
      border-left: 3px solid #022b16;
    }
    .dealer-details strong { color: #0f172a; }

    /* Announcements styling */
    .announcement-card {
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      border: 1px solid #86efac;
      border-left: 4px solid #22c55e;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .announcement-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);
    }
    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }
    .announcement-title {
      font-size: 16px;
      font-weight: 600;
      color: #022b16;
      margin: 0;
    }
    .announcement-badge {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .announcement-description {
      color: #475569;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .announcement-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 13px;
      color: #64748b;
      margin-bottom: 12px;
    }
    .announcement-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .announcement-dealer {
      background: #f8fafc;
      border-radius: 8px;
      padding: 10px 12px;
      border-left: 3px solid #7c3aed;
    }
    .announcement-dealer-title {
      font-size: 11px;
      text-transform: uppercase;
      color: #7c3aed;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .announcement-dealer-info {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 13px;
    }
    .announcement-dealer-info div {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .announcement-dealer-info strong {
      color: #022b16;
    }
    .no-announcements {
      text-align: center;
      padding: 30px;
      color: #64748b;
    }
    .no-announcements svg {
      width: 48px;
      height: 48px;
      margin-bottom: 10px;
      opacity: 0.5;
}

/* Back link */
.single-view-back {
  margin-bottom: 20px;
      text-align: center;
}

.single-view-back a {
  color: #022b16;
  text-decoration: none;
  font-weight: 500;
      padding: 10px 20px;
      background: #e8f5e9;
      border-radius: 6px;
      display: inline-block;
}

.single-view-back a:hover {
      background: #c8e6c9;
    }

    /* Order form inline */
    .order-form {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .order-form input {
      width: 70px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
    .order-form button {
      padding: 6px 12px;
      font-size: 13px;
}

/* Mobile tweaks */
@media (max-width: 768px) {
  .container {
        padding: 15px;
      }
      .accordion {
        font-size: 15px;
        padding: 14px 16px;
      }
      .panel {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <header class="dashboard-hero">
    <div class="dashboard-hero__heading">
      <p>Farmer Command Center</p>
      <h1>Welcome, {{ user.full_name }} (Farmer)</h1>
    </div>
    <div class="dashboard-hero__profile">
      {% include 'partials/profile_section.html' %}
    </div>
  </header>

  <div class="container">
  
    <div id="single-view-back" class="single-view-back" style="display:none;">
      <a href="#" onclick="event.preventDefault(); window.location.href = window.location.pathname;">‚Üê Back to all sections</a>
    </div>

    <!-- Dealer Announcements -->
    <div class="accordion-container">
      <button class="accordion" data-view="announcements">üì¢ Dealer Announcements & Programs</button>
      <div class="panel">
        <div id="announcements-container">
          <!-- Will be filled by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Weather Forecast -->
    <div class="accordion-container">
      <button class="accordion" data-view="weather"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M6.76 4.84L4.96 3.05L3.54 4.46L5.34 6.25C4.53 7.25 4 8.55 4 10C4 13.31 6.69 16 10 16C13.31 16 16 13.31 16 10C16 6.69 13.31 4 10 4C8.55 4 7.25 4.53 6.25 5.34L4.46 3.54L3.05 4.96L4.84 6.76C4.03 7.76 3.5 9.06 3.5 10.5C3.5 14.09 6.41 17 10 17C13.59 17 16.5 14.09 16.5 10.5C16.5 6.91 13.59 4 10 4H10.5C10.5 4 10 4 10 4Z" fill="currentColor"/><path d="M12 8V12L15 15L13.5 16.5L10 13V8H12Z" fill="currentColor"/></svg> Weather Forecast</button>
      <div class="panel">
        {% with weather=weather, variant='compact', theme='light', refresh_seconds=420 %}
          {% include 'partials/weather_widget.html' %}
        {% endwith %}
      </div>
    </div>

    <!-- Market Prices -->
    <div class="accordion-container">
      <button class="accordion" data-view="market"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M7 18C5.9 18 5.01 18.9 5.01 20C5.01 21.1 5.9 22 7 22C8.1 22 9 21.1 9 20C9 18.9 8.1 18 7 18ZM1 2V4H3L6.6 11.59L5.25 14.04C5.09 14.32 5 14.65 5 15C5 16.1 5.9 17 7 17H19V15H7.42C7.28 15 7.17 14.89 7.17 14.75L7.2 14.66L8.1 13H15.55C16.3 13 16.96 12.59 17.3 11.97L20.88 6H22.54L20.68 4H6.27L5.21 2H1ZM17 18C15.9 18 15.01 18.9 15.01 20C15.01 21.1 15.9 22 17 22C18.1 22 19 21.1 19 20C19 18.9 18.1 18 17 18Z" fill="currentColor"/></svg> Market Prices</button>
      <div class="panel">
        {% if market_prices %}
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Commodity</th>
                <th>Price</th>
                <th>Province</th>
                <th>Unit</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for mp in market_prices %}
              <tr>
                <td>{{ mp.id }}</td>
                <td>{{ mp.commodity }}</td>
                <td>{{ mp.price }}</td>
                <td>{{ mp.province or '-' }}</td>
                <td>{{ mp.unit or '-' }}</td>
                <td>{{ mp.date }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="small">Market price data not available.</p>
        {% endif %}
      </div>
    </div>

    <!-- Available Agro-Dealer Inventory -->
    <div class="accordion-container">
      <button class="accordion" data-view="inventory"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M20 6H16L14 4H10L8 6H4C2.9 6 2 6.9 2 8V19C2 20.1 2.9 21 4 21H20C21.1 21 22 20.1 22 19V8C22 6.9 21.1 6 20 6ZM20 19H4V8H6.83L8.83 6H15.17L17.17 8H20V19ZM12 9C9.24 9 7 11.24 7 14C7 16.76 9.24 19 12 19C14.76 19 17 16.76 17 14C17 11.24 14.76 9 12 9ZM12 17C10.35 17 9 15.65 9 14C9 12.35 10.35 11 12 11C13.65 11 15 12.35 15 14C15 15.65 13.65 17 12 17Z" fill="currentColor"/></svg> Available Agro-Dealer Inventory</button>
      <div class="panel">
        {% if inventories %}
          <table>
            <thead>
              <tr>
                <th>Dealer</th>
                <th>Product</th>
                <th>Available Stock</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Order</th>
              </tr>
            </thead>
            <tbody id="inventory-tbody">
              {% for item in inventories %}
              <tr data-inv-id="{{ item.id }}" data-dealer-id="{{ item.dealer_id }}" data-dealer-name="{{ item.dealer_name }}" data-dealer-email="{{ item.dealer_email }}" data-dealer-phone="{{ item.dealer_phone }}">
                <td class="dealer-name">{{ item.dealer_name or ('Dealer #' ~ item.dealer_id) }}</td>
                <td class="product-name">{{ item.product_name }}</td>
                <td class="stock-qty">{{ item.stock }}</td>
                <td class="unit">{{ item.unit }}</td>
                <td>{{ item.price if item.price is not none else '-' }}</td>
                <td>
                  <div class="order-form">
                    <input type="number" class="order-qty" placeholder="Qty" min="1" step="1">
                    <button type="button" class="dealer-order-btn">Order</button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="small">No dealer inventory available yet.</p>
        {% endif %}
      </div>
    </div>

    <!-- My Orders -->
    <div class="accordion-container">
      <button class="accordion" data-view="my-orders"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM8 15.01L9.41 16.42L11 14.84V18H13V14.84L14.59 16.43L16 15.01L12.01 11L8 15.01Z" fill="currentColor"/></svg> My Orders</button>
      <div class="panel">
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
              <th>Dealer</th>
                <th>Product</th>
                <th>Qty</th>
                <th>Status</th>
              </tr>
            </thead>
          <tbody id="my-orders-tbody">
            {% if my_orders %}
              {% for o in my_orders %}
              <tr data-server-order="1">
                <td>{{ o.id }}</td>
                <td>{{ o.dealer_id }}</td>
                <td>{{ o.product_name }}</td>
                <td>{{ o.quantity }} {{ o.unit }}</td>
                <td>{{ o.status }}</td>
              </tr>
              {% endfor %}
            {% endif %}
            </tbody>
          </table>
        <p id="no-my-orders" class="small" style="display:none;">You don't have any orders yet.</p>
      </div>
    </div>

    <!-- Publish Crop Offers for Processors -->
    <div class="accordion-container">
      <button class="accordion" data-view="publish"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M17.5 12C15.01 12 13 14.01 13 16.5C13 18.99 15.01 21 17.5 21C19.99 21 22 18.99 22 16.5C22 14.01 19.99 12 17.5 12ZM17.5 19C16.12 19 15 17.88 15 16.5C15 15.12 16.12 14 17.5 14C18.88 14 20 15.12 20 16.5C20 17.88 18.88 19 17.5 19ZM12.5 2C10.01 2 8 4.01 8 6.5C8 8.99 10.01 11 12.5 11C14.99 11 17 8.99 17 6.5C17 4.01 14.99 2 12.5 2ZM12.5 9C11.12 9 10 7.88 10 6.5C10 5.12 11.12 4 12.5 4C13.88 4 15 5.12 15 6.5C15 7.88 13.88 9 12.5 9ZM5 11C2.79 11 1 12.79 1 15C1 17.21 2.79 19 5 19C7.21 19 9 17.21 9 15C9 12.79 7.21 11 5 11ZM5 17C3.9 17 3 16.1 3 15C3 13.9 3.9 13 5 13C6.1 13 7 13.9 7 15C7 16.1 6.1 17 5 17Z" fill="currentColor"/></svg> Publish Crops for Processors</button>
      <div class="panel">
        <form method="post" action="{{ url_for('farmer_create_crop') }}" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input type="text" name="crop_name" placeholder="Crop name (e.g., Maize)" required style="flex:2; padding:8px;" />
          <input type="number" step="0.01" name="quantity" placeholder="Quantity" required style="width:140px; padding:8px;" />
          <input type="text" name="unit" placeholder="Unit (e.g., kg, ton)" value="kg" style="width:140px; padding:8px;" />
          <input type="number" step="0.01" name="price" placeholder="Price (optional)" style="width:160px; padding:8px;" />
          <input type="text" name="province" placeholder="Province (optional)" style="width:180px; padding:8px;" />
          <button type="submit" style="padding:8px 12px; background:#022b16; color:#fff; border:none; border-radius:4px; cursor:pointer;">Publish</button>
        </form>
        <p class="small" style="margin-top:10px; color:#666;">Once published, your offer appears under "Available Crops" on the Processor dashboard.</p>
      </div>
    </div>

    <!-- Processor Orders (Farmer Approval) -->
    <div class="accordion-container">
      <button class="accordion" data-view="processor-orders">üì¨ Processor Orders (Approve / Reject)</button>
      <div class="panel">
        <table>
          <thead>
            <tr>
              <th>Processor/Customer</th>
              <th>Product</th>
              <th>Quantity</th>
              <th>Unit</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="processor-orders-tbody"></tbody>
        </table>
        <p id="no-processor-orders" class="small">No processor orders yet. When a processor orders your crops, they will appear here.</p>
      </div>
    </div>

    <!-- Farming Tips -->
    <div class="accordion-container">
      <button class="accordion" data-view="tips"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z" fill="currentColor"/></svg> Farming Tips</button>
      <div class="panel">
        <div class="tip-section">
          <h3>Crop-Specific Advice</h3>
          <ul>
            <li>Maize: Use improved seeds, plant 25‚Äì30 cm apart, monitor for stem borers.</li>
            <li>Beans: Rotate crops to reduce soil-borne diseases.</li>
            <li>Irish Potatoes: Ensure proper drainage and avoid planting too deep.</li>
          </ul>
        </div>
        <div class="tip-section">
          <h3>Weather-Based Tips</h3>
          <ul>
            <li>Plant maize seedlings before light rains expected this week.</li>
            <li>Water crops in early morning or late evening during high temperature days.</li>
          </ul>
        </div>
        <div class="tip-section">
          <h3>Market-Informed Tips</h3>
          <ul>
            <li>Focus on harvesting crops with high current market demand.</li>
            <li>Beans prices are trending high in Kigali ‚Äî consider selling.</li>
          </ul>
        </div>
        <div class="tip-section">
          <h3>Sustainable Practices</h3>
          <ul>
            <li>Use composting and crop rotation for soil fertility.</li>
            <li>Implement integrated pest management (IPM).</li>
            <li>Use efficient irrigation techniques and harvest rainwater.</li>
          </ul>
        </div>
        <div class="tip-section">
          <h3>Health & Safety</h3>
          <ul>
            <li>Handle fertilizers and pesticides safely.</li>
            <li>Store crops properly to reduce post-harvest losses.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Current farmer info for order updates (properly escaped for JS)
    const FARMER_INFO = {
      id: {{ user.id|tojson }},
      name: {{ user.full_name|tojson }},
      email: {{ (user.email or "")|tojson }},
      phone: {{ (user.phone or "")|tojson }}
    };
    console.log('Farmer Info loaded:', FARMER_INFO);

    // Accordion functionality
    const acc = document.getElementsByClassName("accordion");
    for (let i = 0; i < acc.length; i++) {
      acc[i].addEventListener("click", function(e) {
        const view = this.getAttribute('data-view');
        if (view) {
          e.preventDefault();
          const url = new URL(window.location.href);
          url.searchParams.set('view', view);
          window.location.href = url.toString();
          return;
        }
        for (let j = 0; j < acc.length; j++) {
          if (acc[j] !== this) {
            acc[j].classList.remove("active");
            acc[j].nextElementSibling.style.display = "none";
          }
        }
        this.classList.toggle("active");
        const panel = this.nextElementSibling;
        panel.style.display = (panel.style.display === "block") ? "none" : "block";
      });
    }

    // Single-section page view handler using ?view=<key>
    (function(){
      const params = new URLSearchParams(window.location.search);
      const view = params.get('view');
      if (!view) return;
      const containers = document.querySelectorAll('.accordion-container');
      let found = false;
      containers.forEach(function(c){
        const btn = c.querySelector('.accordion');
        if (btn && btn.getAttribute('data-view') === view) {
          found = true;
          btn.classList.add('active');
          const panel = btn.nextElementSibling;
          if (panel) panel.style.display = 'block';
          c.style.display = 'block';
        } else {
          c.style.display = 'none';
        }
      });
      if (found) {
        const back = document.getElementById('single-view-back');
        if (back) back.style.display = 'block';
      }
    })();

    // --- Toast notifications ---
    function showToast(message) {
      const t = document.createElement('div');
      t.style.cssText = 'position:fixed;right:20px;bottom:20px;background:rgba(0,0,0,0.85);color:#fff;padding:12px 18px;border-radius:8px;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.2);opacity:0;transform:translateY(10px);transition:opacity .25s ease, transform .25s ease;z-index:9999;';
      t.textContent = message;
      document.body.appendChild(t);
      requestAnimationFrame(()=>{ t.style.opacity = '1'; t.style.transform = 'translateY(0)'; });
      setTimeout(()=>{ t.style.opacity = '0'; t.style.transform = 'translateY(10px)'; setTimeout(()=> t.remove(), 250); }, 2500);
    }

    // ========== DEALER ANNOUNCEMENTS (Database API) ==========
    async function fetchAnnouncements() {
      try {
        const response = await fetch('/api/announcements');
        if (response.ok) {
          return await response.json();
        }
        return [];
      } catch (e) {
        console.error('Error fetching announcements:', e);
        return [];
      }
    }

    async function renderAnnouncements() {
      const container = document.getElementById('announcements-container');
      if (!container) return;

      container.innerHTML = '<p style="text-align:center; color:#666;">Loading announcements...</p>';

      const announcements = await fetchAnnouncements();
      
      if (announcements.length === 0) {
        container.innerHTML = `
          <div class="no-announcements">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
            </svg>
            <p>No announcements from agro-dealers yet.</p>
            <p style="font-size:12px;">Check back later for subsidies and programs!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = announcements.map(a => {
        const validDates = [];
        if (a.valid_from) validDates.push(`From: ${a.valid_from}`);
        if (a.valid_to) validDates.push(`To: ${a.valid_to}`);
        
        return `
          <div class="announcement-card">
            <div class="announcement-header">
              <h4 class="announcement-title">${a.title}</h4>
              <span class="announcement-badge">${a.commodity || 'General'}</span>
            </div>
            ${a.description ? `<p class="announcement-description">${a.description}</p>` : ''}
            <div class="announcement-meta">
              ${a.discount_percent ? `<span>üè∑Ô∏è <strong>${a.discount_percent}%</strong> Discount</span>` : ''}
              ${validDates.length ? `<span>üìÖ ${validDates.join(' - ')}</span>` : ''}
            </div>
            <div class="announcement-dealer">
              <div class="announcement-dealer-title">üìû Contact Agro-Dealer</div>
              <div class="announcement-dealer-info">
                <div><strong>üë§ ${a.dealer_name || 'N/A'}</strong></div>
                <div>üìß ${a.dealer_email || 'N/A'}</div>
                <div>üì± ${a.dealer_phone || 'N/A'}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ========== FARMER-DEALER ORDERS (Database API) ==========
    async function fetchMyDealerOrders() {
      try {
        const response = await fetch('/api/farmer-dealer-orders');
        if (response.ok) {
          return await response.json();
        }
        return [];
      } catch (e) {
        console.error('Error fetching my orders:', e);
        return [];
      }
    }

    // Render My Orders (from database)
    async function renderMyOrders() {
      const tbody = document.getElementById('my-orders-tbody');
      if (!tbody) return;
      
      // Clear dynamic rows
      tbody.querySelectorAll('[data-db-order="1"]').forEach(r => r.remove());
      
      const orders = await fetchMyDealerOrders();
      console.log('My dealer orders:', orders);
      
      orders.forEach(o => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-db-order', '1');
        
        let statusHtml = '';
        const statusLower = (o.status || '').toLowerCase();
        
        // Always show dealer details
        const dealerDetails = `
          <div class="dealer-details">
            <strong>üë§ Dealer:</strong> ${o.dealer_name || 'N/A'}<br>
            <strong>üìß Email:</strong> ${o.dealer_email || 'N/A'}<br>
            <strong>üì± Phone:</strong> ${o.dealer_phone || 'N/A'}
          </div>
        `;
        
        if (statusLower === 'approved') {
          statusHtml = `
            <span class="status-badge status-approved">‚úì Approved</span>
            ${dealerDetails}
          `;
        } else if (statusLower === 'rejected') {
          statusHtml = `
            <span class="status-badge status-rejected">‚úó Rejected</span>
            ${dealerDetails}
          `;
        } else if (statusLower === 'delivered') {
          statusHtml = `
            <span class="status-badge status-delivered">üì¶ Delivered</span>
            ${dealerDetails}
          `;
        } else {
          statusHtml = `
            <span class="status-badge status-pending">‚è≥ Pending Dealer Approval</span>
            ${dealerDetails}
          `;
        }
        
        tr.innerHTML = `
          <td>${o.id || '-'}</td>
          <td>${o.dealer_name || '-'}</td>
          <td>${o.product_name || '-'}</td>
          <td>${o.quantity || '-'} ${o.unit || ''}</td>
          <td>${statusHtml}</td>
        `;
        tbody.appendChild(tr);
      });
      
      const serverRows = tbody.querySelectorAll('[data-server-order="1"]').length;
      const emptyMsg = document.getElementById('no-my-orders');
      if (emptyMsg) {
        emptyMsg.style.display = (orders.length === 0 && serverRows === 0) ? 'block' : 'none';
      }
    }

    // Update stock quantity in UI
    function updateStockUI(invId, reduction) {
      const row = document.querySelector(`tr[data-inv-id="${invId}"]`);
      if (row) {
        const stockCell = row.querySelector('.stock-qty');
        if (stockCell) {
          const currentStock = parseFloat(stockCell.textContent) || 0;
          const newStock = Math.max(0, currentStock - reduction);
          stockCell.textContent = newStock;
          if (newStock <= 0) {
            row.style.opacity = '0.5';
            const btn = row.querySelector('.dealer-order-btn');
            if (btn) btn.disabled = true;
          }
        }
      }
    }

    // Create order to dealer via API
    async function createDealerOrder(dealerId, productName, quantity, unit) {
      try {
        const response = await fetch('/api/farmer-dealer-orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            dealer_id: dealerId,
            product_name: productName,
            quantity: quantity,
            unit: unit
          })
        });
        const data = await response.json();
        return response.ok ? { success: true } : { success: false, error: data.error };
      } catch (e) {
        console.error('Error creating order:', e);
        return { success: false, error: e.message };
      }
    }

    // Attach order buttons for dealer inventory
    function attachDealerOrderButtons() {
      const buttons = document.querySelectorAll('.dealer-order-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', async function(e) {
          e.preventDefault();
          const row = this.closest('tr');
          const qtyInput = row.querySelector('.order-qty');
          const qty = qtyInput ? qtyInput.value.trim() : '';
          
          if (!qty || parseFloat(qty) <= 0) {
            alert('Please enter a valid quantity');
            return;
          }
          
          const availableStock = parseFloat(row.querySelector('.stock-qty')?.textContent) || 0;
          if (parseFloat(qty) > availableStock) {
            alert(`Cannot order more than available stock (${availableStock})`);
            return;
          }
          
          const dealerId = row.getAttribute('data-dealer-id');
          const productName = row.querySelector('.product-name')?.textContent?.trim() || '';
          const unit = row.querySelector('.unit')?.textContent?.trim() || '';

          // Disable button while processing
          this.disabled = true;
          this.textContent = 'Ordering...';

          const result = await createDealerOrder(dealerId, productName, parseFloat(qty), unit);
          
          if (result.success) {
            // Clear input
            if (qtyInput) qtyInput.value = '';
            await renderMyOrders();
            showToast('Order sent to dealer for approval.');
          } else {
            alert('Error: ' + (result.error || 'Could not create order'));
          }

          this.disabled = false;
          this.textContent = 'Order';
        });
      });
    }

    // ========== PROCESSOR-FARMER ORDERS (Database API) ==========
    async function fetchFarmerOrders() {
      try {
        const response = await fetch('/api/processor-orders');
        if (response.ok) {
          return await response.json();
        }
        return [];
      } catch (e) {
        console.error('Error fetching orders:', e);
        return [];
      }
    }

    async function updateOrderStatus(orderId, action) {
      try {
        const response = await fetch(`/api/processor-orders/${orderId}/action`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: action })
        });
        const data = await response.json();
        return response.ok ? { success: true, status: data.status } : { success: false, error: data.error };
      } catch (e) {
        console.error('Error updating order:', e);
        return { success: false, error: e.message };
      }
    }

    async function renderFarmerOrders() {
      const tbody = document.getElementById('processor-orders-tbody');
      if (!tbody) return;
      
      const orders = await fetchFarmerOrders();
      tbody.innerHTML = '';
      let pendingCount = 0;
      let processedCount = 0;

      console.log('Fetched orders from DB:', orders);

      // Show pending orders that need action
      orders.forEach(o => {
        if ((o.status || '').toLowerCase() !== 'pending') return;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.customer_name || ''}</td>
          <td>${o.product_name || ''}</td>
          <td>${o.quantity || ''}</td>
          <td>${o.unit || ''}</td>
          <td><span class="status-badge status-pending">Pending Approval</span></td>
          <td>
            <button class="approve-btn" data-id="${o.id}">‚úì Approve</button>
            <button class="reject-btn" data-id="${o.id}" style="margin-left:6px;">‚úó Reject</button>
          </td>
        `;
        tbody.appendChild(tr);
        pendingCount++;
      });

      // Show processed orders (approved/rejected)
      orders.forEach(o => {
        const statusLower = (o.status || '').toLowerCase();
        if (statusLower !== 'approved' && statusLower !== 'rejected') return;
        
        const isApproved = statusLower === 'approved';
        const statusClass = isApproved ? 'status-approved' : 'status-rejected';
        const statusText = isApproved ? '‚úì Approved' : '‚úó Rejected';
        const changeAction = isApproved ? 'reject' : 'approve';
        const changeLabel = isApproved ? 'Change to Reject' : 'Change to Approve';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.customer_name || ''}</td>
          <td>${o.product_name || ''}</td>
          <td>${o.quantity || ''}</td>
          <td>${o.unit || ''}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td><button class="change-decision" data-id="${o.id}" data-action="${changeAction}">${changeLabel}</button></td>
        `;
        tbody.appendChild(tr);
        processedCount++;
      });

      console.log('Pending orders:', pendingCount, 'Processed orders:', processedCount);

      const empty = document.getElementById('no-processor-orders');
      if (empty) empty.style.display = (pendingCount === 0 && processedCount === 0) ? 'block' : 'none';

      // Attach handlers for approve buttons
      tbody.querySelectorAll('.approve-btn').forEach(btn => btn.addEventListener('click', async function() {
        const id = this.getAttribute('data-id');
        this.disabled = true;
        this.textContent = 'Processing...';
        
        const result = await updateOrderStatus(id, 'approve');
        if (result.success) {
          await renderFarmerOrders();
          showToast('Order approved!');
        } else {
          alert('Error: ' + (result.error || 'Could not approve order'));
          this.disabled = false;
          this.textContent = '‚úì Approve';
        }
      }));

      // Attach handlers for reject buttons
      tbody.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', async function() {
        const id = this.getAttribute('data-id');
        this.disabled = true;
        this.textContent = 'Processing...';
        
        const result = await updateOrderStatus(id, 'reject');
        if (result.success) {
          await renderFarmerOrders();
          showToast('Order rejected.');
        } else {
          alert('Error: ' + (result.error || 'Could not reject order'));
          this.disabled = false;
          this.textContent = '‚úó Reject';
        }
      }));

      // Attach handlers for change decision buttons
      tbody.querySelectorAll('.change-decision').forEach(btn => btn.addEventListener('click', async function() {
        const id = this.getAttribute('data-id');
        const action = this.getAttribute('data-action');
        this.disabled = true;
        this.textContent = 'Processing...';
        
        const result = await updateOrderStatus(id, action);
        if (result.success) {
          await renderFarmerOrders();
          showToast('Decision changed successfully!');
        } else {
          alert('Error: ' + (result.error || 'Could not change decision'));
          this.disabled = false;
          this.textContent = action === 'approve' ? 'Change to Approve' : 'Change to Reject';
        }
      }));
    }

    // Initial render
    attachDealerOrderButtons();
    renderMyOrders();
    renderFarmerOrders();
    renderAnnouncements();

    // Refresh data periodically
    setInterval(renderFarmerOrders, 30000);
    setInterval(renderMyOrders, 30000);
    setInterval(renderAnnouncements, 60000);
  </script>
  <script src="{{ url_for('static', filename='weather.js') }}"></script>
</body>
</html>
