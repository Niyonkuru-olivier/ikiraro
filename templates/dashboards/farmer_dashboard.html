<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Farmer Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='profile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='weather-widget.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='mobile-responsive.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: #f5f7fa;
  margin: 0;
  padding: 0;
  color: #333;
}

header {
  background: linear-gradient(135deg, #022b16, #022b16);
  color: white;
  padding: 24px;
  text-align: left;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.container {
  padding: 25px;
  max-width: 1400px;
  margin: auto;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
  grid-gap: 20px;
}

/* Accordion Buttons */
.accordion {
  background-color: #022b16;
  color: #fff;
  cursor: pointer;
  padding: 16px;
  width: 100%;
  text-align: left;
  border: none;
  outline: none;
  transition: all 0.3s ease;
  border-radius: 8px;
  font-size: 17px;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.accordion::after {
  content: '\25BC';
  font-size: 14px;
  transition: transform 0.3s;
}

.accordion.active::after {
  transform: rotate(-180deg);
}

.accordion.active,
.accordion:hover {
  background-color: #022b16;
}

.panel {
 display: none; /* Hidden by default */
  padding: 15px;
  background-color: white;
  border: 1px solid #ccc;

}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Tables */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
  font-size: 14px;
}

th, td {
  border: 1px solid #e0e0e0;
  padding: 10px 12px;
  text-align: left;
}

th {
  background: #022b16;
  color: white;
  font-weight: 500;
}

td {
  background: #fafafa;
}

tr:nth-child(even) td {
  background: #f0fdfb;
}

/* Charts */
.chart-container {
  width: 100%;
  height: 320px;
  margin-top: 10px;
}

/* Farming Tips */
.tip-section {
  margin-bottom: 20px;
}

.tip-section h3 {
  margin-top: 0;
  color: #022b16;
  font-size: 16px;
}

.tip-section ul {
  padding-left: 18px;
  margin: 6px 0;
}

.tip-section li {
  margin-bottom: 6px;
  line-height: 1.4;
}

/* Buttons & Forms */
form input, form button {
  border-radius: 6px;
  border: 1px solid #ccc;
  padding: 8px 10px;
  font-size: 14px;
}

form button {
  background: #022b16;
  color: white;
  border: none;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.3s;
}

form button:hover {
  background: #022b16;
}

/* Back link */
.single-view-back {
  margin-bottom: 20px;
}

.single-view-back a {
  color: #022b16;
  text-decoration: none;
  font-weight: 500;
}

.single-view-back a:hover {
  text-decoration: underline;
}

/* Mobile tweaks */
@media (max-width: 768px) {
  .container {
    grid-template-columns: 1fr;
  }
}

  </style>
</head>
<body>
  <header class="dashboard-hero">
    <div class="dashboard-hero__heading">
      <p>Farmer Command Center</p>
      <h1>Welcome, {{ user.full_name }} (Farmer)</h1>
    </div>
    <div class="dashboard-hero__profile">
      {% include 'partials/profile_section.html' %}
    </div>
  </header>

  <div class="container">
  
    <div id="single-view-back" class="single-view-back" style="display:none;">
      <a href="{{ url_for('farmer_dashboard') if false else '#' }}" onclick="event.preventDefault(); window.location.href = window.location.pathname;">‚Üê Back to all sections</a>
    </div>
    <!-- Weather Forecast -->
    <div class="accordion-container">
      <button class="accordion" data-view="weather"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M6.76 4.84L4.96 3.05L3.54 4.46L5.34 6.25C4.53 7.25 4 8.55 4 10C4 13.31 6.69 16 10 16C13.31 16 16 13.31 16 10C16 6.69 13.31 4 10 4C8.55 4 7.25 4.53 6.25 5.34L4.46 3.54L3.05 4.96L4.84 6.76C4.03 7.76 3.5 9.06 3.5 10.5C3.5 14.09 6.41 17 10 17C13.59 17 16.5 14.09 16.5 10.5C16.5 6.91 13.59 4 10 4H10.5C10.5 4 10 4 10 4Z" fill="currentColor"/><path d="M12 8V12L15 15L13.5 16.5L10 13V8H12Z" fill="currentColor"/></svg> Weather Forecast</button>
      <div class="panel">
        {% with weather=weather, variant='compact', refresh_seconds=420 %}
          {% include 'partials/weather_widget.html' %}
        {% endwith %}
      </div>
    </div>

    <!-- Market Prices -->
    <div class="accordion-container">
      <button class="accordion" data-view="market"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M7 18C5.9 18 5.01 18.9 5.01 20C5.01 21.1 5.9 22 7 22C8.1 22 9 21.1 9 20C9 18.9 8.1 18 7 18ZM1 2V4H3L6.6 11.59L5.25 14.04C5.09 14.32 5 14.65 5 15C5 16.1 5.9 17 7 17H19V15H7.42C7.28 15 7.17 14.89 7.17 14.75L7.2 14.66L8.1 13H15.55C16.3 13 16.96 12.59 17.3 11.97L20.88 6H22.54L20.68 4H6.27L5.21 2H1ZM17 18C15.9 18 15.01 18.9 15.01 20C15.01 21.1 15.9 22 17 22C18.1 22 19 21.1 19 20C19 18.9 18.1 18 17 18Z" fill="currentColor"/></svg> Market Prices</button>
      <div class="panel">
        {% if market_prices %}
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Commodity</th>
                <th>Price</th>
                <th>Province</th>
                <th>Unit</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for mp in market_prices %}
              <tr>
                <td>{{ mp.id }}</td>
                <td>{{ mp.commodity }}</td>
                <td>{{ mp.price }}</td>
                <td>{{ mp.province or '-' }}</td>
                <td>{{ mp.unit or '-' }}</td>
                <td>{{ mp.date }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="small">Market price data not available.</p>
        {% endif %}
      </div>
    </div>

    <!-- Available Agro-Dealer Inventory -->
    <div class="accordion-container">
      <button class="accordion" data-view="inventory"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M20 6H16L14 4H10L8 6H4C2.9 6 2 6.9 2 8V19C2 20.1 2.9 21 4 21H20C21.1 21 22 20.1 22 19V8C22 6.9 21.1 6 20 6ZM20 19H4V8H6.83L8.83 6H15.17L17.17 8H20V19ZM12 9C9.24 9 7 11.24 7 14C7 16.76 9.24 19 12 19C14.76 19 17 16.76 17 14C17 11.24 14.76 9 12 9ZM12 17C10.35 17 9 15.65 9 14C9 12.35 10.35 11 12 11C13.65 11 15 12.35 15 14C15 15.65 13.65 17 12 17Z" fill="currentColor"/></svg> Available Agro-Dealer Inventory</button>
      <div class="panel">
        {% if inventories %}
          <table>
            <thead>
              <tr>
                <th>Dealer ID</th>
                <th>Product</th>
                <th>Stock</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Order</th>
              </tr>
            </thead>
            <tbody>
              {% for item in inventories %}
              <tr>
                <td>{{ item.dealer_id }}</td>
                <td>{{ item.product_name }}</td>
                <td>{{ item.stock }}</td>
                <td>{{ item.unit }}</td>
                <td>{{ item.price if item.price is not none else '-' }}</td>
                <td>
                  <form method="post" action="{{ url_for('farmer_create_order') }}" style="display:flex; gap:6px; align-items:center;">
                    <input type="hidden" name="dealer_id" value="{{ item.dealer_id }}" />
                    <input type="hidden" name="product_name" value="{{ item.product_name }}" />
                    <input type="number" name="quantity" placeholder="Qty" min="1" required style="width:80px; padding:6px;" />
                    <input type="text" name="unit" value="{{ item.unit }}" style="width:70px; padding:6px;" />
                    <button type="submit" style="padding:6px 10px; background:#022b16; color:#fff; border:none; border-radius:4px; cursor:pointer;">Order</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="small">No dealer inventory available yet.</p>
        {% endif %}
      </div>
    </div>

    <!-- My Orders -->
    <div class="accordion-container">
      <button class="accordion" data-view="my-orders"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM8 15.01L9.41 16.42L11 14.84V18H13V14.84L14.59 16.43L16 15.01L12.01 11L8 15.01Z" fill="currentColor"/></svg> My Orders</button>
      <div class="panel">
        {% if my_orders %}
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Dealer ID</th>
                <th>Product</th>
                <th>Qty</th>
                <th>Status</th>
                <th>Created</th>
                <th>Last Update</th>
              </tr>
            </thead>
            <tbody>
              {% for o in my_orders %}
              <tr>
                <td>{{ o.id }}</td>
                <td>{{ o.dealer_id }}</td>
                <td>{{ o.product_name }}</td>
                <td>{{ o.quantity }} {{ o.unit }}</td>
                <td>{{ o.status }}</td>
                <td>{{ o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at else '-' }}</td>
                <td>{{ o.updated_at.strftime('%Y-%m-%d %H:%M') if o.updated_at else '-' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="small">You don't have any orders yet.</p>
        {% endif %}
      </div>
    </div>

    <!-- Publish Crop Offers for Processors -->
    <div class="accordion-container">
      <button class="accordion" data-view="publish"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M17.5 12C15.01 12 13 14.01 13 16.5C13 18.99 15.01 21 17.5 21C19.99 21 22 18.99 22 16.5C22 14.01 19.99 12 17.5 12ZM17.5 19C16.12 19 15 17.88 15 16.5C15 15.12 16.12 14 17.5 14C18.88 14 20 15.12 20 16.5C20 17.88 18.88 19 17.5 19ZM12.5 2C10.01 2 8 4.01 8 6.5C8 8.99 10.01 11 12.5 11C14.99 11 17 8.99 17 6.5C17 4.01 14.99 2 12.5 2ZM12.5 9C11.12 9 10 7.88 10 6.5C10 5.12 11.12 4 12.5 4C13.88 4 15 5.12 15 6.5C15 7.88 13.88 9 12.5 9ZM5 11C2.79 11 1 12.79 1 15C1 17.21 2.79 19 5 19C7.21 19 9 17.21 9 15C9 12.79 7.21 11 5 11ZM5 17C3.9 17 3 16.1 3 15C3 13.9 3.9 13 5 13C6.1 13 7 13.9 7 15C7 16.1 6.1 17 5 17Z" fill="currentColor"/></svg> Publish Crops for Processors</button>
      <div class="panel">
        <form method="post" action="{{ url_for('farmer_create_crop') }}" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input type="text" name="crop_name" placeholder="Crop name (e.g., Maize)" required style="flex:2; padding:8px;" />
          <input type="number" step="0.01" name="quantity" placeholder="Quantity" required style="width:140px; padding:8px;" />
          <input type="text" name="unit" placeholder="Unit (e.g., kg, ton)" value="kg" style="width:140px; padding:8px;" />
          <input type="number" step="0.01" name="price" placeholder="Price (optional)" style="width:160px; padding:8px;" />
          <input type="text" name="province" placeholder="Province (optional)" style="width:180px; padding:8px;" />
          <button type="submit" style="padding:8px 12px; background:#022b16; color:#fff; border:none; border-radius:4px; cursor:pointer;">Publish</button>
        </form>
        <p class="small">Once published, your offer appears under "Available Crops" on the Processor dashboard.</p>
      </div>
    </div>

    <!-- Processor Orders (Farmer Approval) -->
    <div class="accordion-container">
      <button class="accordion" data-view="processor-orders">üì¨ Processor Orders (Approve / Reject)</button>
      <div class="panel">
        <table>
          <thead>
            <tr>
              <th>Processor</th>
              <th>Product</th>
              <th>Quantity</th>
              <th>Unit</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="processor-orders-tbody"></tbody>
        </table>
        <p id="no-processor-orders" class="small">No processor orders yet.</p>
      </div>
    </div>


    <!-- Farming Tips -->
    <div class="accordion-container">
      <button class="accordion" data-view="tips"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z" fill="currentColor"/></svg> Farming Tips</button>
      <div class="panel">
        <div class="tip-section">
          <h3>Crop-Specific Advice</h3>
          <ul>
            <li>Maize: Use improved seeds, plant 25‚Äì30 cm apart, monitor for stem borers.</li>
            <li>Beans: Rotate crops to reduce soil-borne diseases.</li>
            <li>Irish Potatoes: Ensure proper drainage and avoid planting too deep.</li>
          </ul>
        </div>
        <div class="tip-section">
          <h3>Weather-Based Tips</h3>
          <ul>
            <li>Plant maize seedlings before light rains expected this week.</li>
            <li>Water crops in early morning or late evening during high temperature days.</li>
          </ul>
        </div>
        <div class="tip-section">
          <h3>Market-Informed Tips</h3>
          <ul>
            <li>Focus on harvesting crops with high current market demand.</li>
            <li>Beans prices are trending high in Kigali ‚Äî consider selling.</li>
          </ul>
        </div>
        <div class="tip-section">
          <h3>Sustainable Practices</h3>
          <ul>
            <li>Use composting and crop rotation for soil fertility.</li>
            <li>Implement integrated pest management (IPM).</li>
            <li>Use efficient irrigation techniques and harvest rainwater.</li>
          </ul>
        </div>
        <div class="tip-section">
          <h3>Health & Safety</h3>
          <ul>
            <li>Handle fertilizers and pesticides safely.</li>
            <li>Store crops properly to reduce post-harvest losses.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Accordion: Only one open at a time
    const acc = document.getElementsByClassName("accordion");
    for (let i = 0; i < acc.length; i++) {
      acc[i].addEventListener("click", function(e) {
        const view = this.getAttribute('data-view');
        if (view) {
          e.preventDefault();
          const url = new URL(window.location.href);
          url.searchParams.set('view', view);
          window.location.href = url.toString();
          return;
        }
        for (let j = 0; j < acc.length; j++) {
          if (acc[j] !== this) {
            acc[j].classList.remove("active");
            acc[j].nextElementSibling.style.display = "none";
          }
        }
        this.classList.toggle("active");
        const panel = this.nextElementSibling;
        panel.style.display = (panel.style.display === "block") ? "none" : "block";
      });
    }

    // Single-section page view handler using ?view=<key>
    (function(){
      const params = new URLSearchParams(window.location.search);
      const view = params.get('view');
      if (!view) return;
      const containers = document.querySelectorAll('.accordion-container');
      let found = false;
      containers.forEach(function(c){
        const btn = c.querySelector('.accordion');
        if (btn && btn.getAttribute('data-view') === view) {
          found = true;
          btn.classList.add('active');
          const panel = btn.nextElementSibling; if (panel) panel.style.display = 'block';
          c.style.display = 'block';
        } else {
          c.style.display = 'none';
        }
      });
      if (found) {
        const back = document.getElementById('single-view-back');
        if (back) back.style.display = 'block';
      }
    })();

    // --- Toast notifications ---
    function showToast(message) {
      const t = document.createElement('div');
      t.style.position = 'fixed';
      t.style.right = '20px';
      t.style.bottom = '20px';
      t.style.background = 'rgba(0,0,0,0.85)';
      t.style.color = '#fff';
      t.style.padding = '10px 14px';
      t.style.borderRadius = '6px';
      t.style.fontSize = '14px';
      t.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
      t.style.opacity = '0';
      t.style.transform = 'translateY(10px)';
      t.style.transition = 'opacity .25s ease, transform .25s ease';
      t.textContent = message;
      document.body.appendChild(t);
      requestAnimationFrame(()=>{ t.style.opacity = '1'; t.style.transform = 'translateY(0)'; });
      setTimeout(()=>{ t.style.opacity = '0'; t.style.transform = 'translateY(10px)'; setTimeout(()=> t.remove(), 250); }, 2500);
    }

    // --- Shared localStorage order store used by processor and farmer ---
    function getStoredOrders() {
      try { return JSON.parse(localStorage.getItem('processor_customer_orders') || '[]'); } catch (e) { return []; }
    }
    function saveStoredOrders(orders) {
      localStorage.setItem('processor_customer_orders', JSON.stringify(orders));
    }

    function renderFarmerOrders() {
      const tbody = document.getElementById('processor-orders-tbody');
      if (!tbody) return;
      const orders = getStoredOrders();
      tbody.innerHTML = '';
      let shown = 0;
      orders.forEach(o => {
        // Show only orders that need farmer action and were created by processor
        if ((o.status || '').toLowerCase() !== 'pending farmer approval') return;
        if (!o.customer_name || o.customer_name === '{{ user.full_name }}') return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.customer_name || ''}</td>
          <td>${o.product_name || ''}</td>
          <td>${o.quantity || ''}</td>
          <td>${o.unit || ''}</td>
          <td class="status">${o.status || ''}</td>
          <td>
            <button class="approve-btn" data-id="${o.id}">Approve</button>
            <button class="reject-btn" data-id="${o.id}" style="margin-left:6px;">Reject</button>
          </td>
        `;
        tbody.appendChild(tr);
        shown++;
      });
      const empty = document.getElementById('no-processor-orders');
      if (empty) empty.style.display = shown === 0 ? 'block' : 'none';

      // Attach handlers
      tbody.querySelectorAll('.approve-btn').forEach(btn => btn.addEventListener('click', function() {
        const id = Number(this.getAttribute('data-id'));
        const orders = getStoredOrders();
        const idx = orders.findIndex(o => o.id === id);
        if (idx >= 0) {
          orders[idx].status = 'Approved by Farmer';
          orders[idx].updated_at = new Date().toISOString();
          saveStoredOrders(orders);
          renderFarmerOrders();
          showToast('Order approved.');
        }
      }));
      tbody.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', function() {
        const id = Number(this.getAttribute('data-id'));
        const orders = getStoredOrders();
        const idx = orders.findIndex(o => o.id === id);
        if (idx >= 0) {
          orders[idx].status = 'Rejected by Farmer';
          orders[idx].updated_at = new Date().toISOString();
          saveStoredOrders(orders);
          renderFarmerOrders();
          showToast('Order rejected.');
        }
      }));

      // Add ability to change decision later and delete
      // Keep approved/rejected orders visible with actions
      const fullTbody = document.getElementById('processor-orders-tbody');
      const allOrders = getStoredOrders();
      allOrders.forEach(o => {
        if ((o.status || '').toLowerCase() === 'approved by farmer' || (o.status || '').toLowerCase() === 'rejected by farmer') {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${o.customer_name || ''}</td>
            <td>${o.product_name || ''}</td>
            <td>${o.quantity || ''}</td>
            <td>${o.unit || ''}</td>
            <td class="status">${o.status || ''}</td>
            <td>
              <button class="change-decision" data-id="${o.id}">Change decision</button>
              <button class="delete-decision" data-id="${o.id}" style="margin-left:6px;">Delete</button>
            </td>
          `;
          fullTbody.appendChild(tr);
        }
      });

      fullTbody.querySelectorAll('.change-decision').forEach(btn => btn.addEventListener('click', function() {
        const id = Number(this.getAttribute('data-id'));
        const orders = getStoredOrders();
        const idx = orders.findIndex(o => o.id === id);
        if (idx >= 0) {
          const current = (orders[idx].status || '').toLowerCase();
          const next = current.includes('approved') ? 'Rejected by Farmer' : 'Approved by Farmer';
          orders[idx].status = next;
          orders[idx].updated_at = new Date().toISOString();
          saveStoredOrders(orders);
          renderFarmerOrders();
          showToast('Decision updated.');
        }
      }));
      fullTbody.querySelectorAll('.delete-decision').forEach(btn => btn.addEventListener('click', function() {
        const id = Number(this.getAttribute('data-id'));
        const orders = getStoredOrders();
        const idx = orders.findIndex(o => o.id === id);
        if (idx >= 0) {
          orders.splice(idx, 1);
          saveStoredOrders(orders);
          renderFarmerOrders();
          showToast('Decision and order removed.');
        }
      }));
    }

    // Initial render and sync if other tabs update
    renderFarmerOrders();
    window.addEventListener('storage', (e) => {
      if (e.key === 'processor_customer_orders') {
        renderFarmerOrders();
      }
    });

    // Farmer creates an order for processor
    const farmerOrderForm = document.getElementById('farmer-create-processor-order');
    if (farmerOrderForm) {
      farmerOrderForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const product = document.getElementById('fpo-product').value.trim();
        const qty = document.getElementById('fpo-qty').value.trim();
        const unit = document.getElementById('fpo-unit').value.trim();
        if (!product || !qty) return;
        const orders = getStoredOrders();
        orders.push({
          id: Date.now(),
          customer_name: '{{ user.full_name }}',
          farmer_name: '{{ user.full_name }}',
          product_name: product,
          quantity: qty,
          unit: unit || 'kg',
          status: 'Pending Processor Review',
          created_at: new Date().toISOString(),
          updated_at: null
        });
        saveStoredOrders(orders);
        // Clear form
        document.getElementById('fpo-product').value = '';
        document.getElementById('fpo-qty').value = '';
        // Notify
        alert('Order submitted and visible to the processor.');
      });
    }
  </script>
  <script src="{{ url_for('static', filename='weather.js') }}"></script>
</body>
</html>