<!-- templates/dashboards/researcher_dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Researcher Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='profile.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='weather-widget.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='mobile-responsive.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #eef2fb; margin: 0; padding: 0; }
    header { background: #022b16; color: white; padding: 20px; text-align: left; }
    .container { padding: 20px; max-width: 1100px; margin: auto; display: flex; flex-direction: column; gap: 15px; }

    .accordion { background-color: #022b16; color: white; cursor: pointer; 
      padding: 20px; text-align: center;
                 font-size: 18px; border: none; outline: none; transition: 0.4s; border-radius: 8px;
                 box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .accordion.active, .accordion:hover { background-color: #022b16; }
    .panel { padding: 15px; display: none; background-color: white; border-radius: 8px;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1); animation: fadeIn 0.3s ease-in-out; 
             overflow-x: auto; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #022b16; color: white; }
    a.download-btn { display: inline-block; margin-top: 10px; padding: 10px 15px; 
      background: #022b16; color: white; text-decoration: none; border-radius: 5px; }
    a.download-btn:hover { background: #022b16; }

    .chart-grid { display: grid; gap: 18px; margin-top: 20px; }
    .chart-grid.two-cols { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .chart-grid.three-cols { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .chart-card {
      background: linear-gradient(135deg, #f8fafc, #eef4ff);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 10px 25px rgba(19, 35, 58, 0.12);
      border: 1px solid rgba(2, 43, 22, 0.08);
    }
    .chart-card h3 { margin: 0 0 6px; color: #022b16; font-size: 16px; display: flex; align-items: center; gap: 6px; }
    .chart-subtext { margin: 0 0 12px; color: #4b5563; font-size: 13px; }
    canvas { width: 100% !important; height: 320px !important; }

    .nisr-title { background:#fff3e0; padding:12px; border-radius:6px; 
      color:#6b4226; font-weight:600; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to
     { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <header class="dashboard-hero">
    <div class="dashboard-hero__heading">
      <p>R&D Intelligence Hub</p>
      <h1>Welcome, {{ user.full_name }} (Researcher)</h1>
    </div>
    <div class="dashboard-hero__profile">
      {% include 'partials/profile_section.html' %}
    </div>
  </header>

  <div class="container">
    
    {% with weather=weather, variant='compact', theme='light', refresh_seconds=480 %}
      {% include 'partials/weather_widget.html' %}
    {% endwith %}

    <!-- Market Prices (DB) -->
    <button class="accordion"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M3.5 18.49L9.5 12.49L13.5 16.49L22 6.92V20.5C22 21.05 21.55 21.5 21 21.5H3C2.45 21.5 2 21.05 2 20.5V18.49L3.5 18.49ZM21 4.5H3C2.45 4.5 2 4.95 2 5.5V7.51L3.5 7.51L9.5 13.51L13.5 9.51L21 1.92V4.5Z" fill="currentColor"/></svg> Market Price Data </button>
    <div class="panel">
      <p>The Market price data provides insights into the pricing trends of various commodities Over
      time especially in 2025. This dataset is crucial for researchers analyzing market dynamics, price fluctuations,
      and economic factors affecting agricuture in Rwanda. in This Dataset we take the example onn th
commodity of Beans, Maize and Cassava      </p>
      <h2>Market Price Dataset</h2>
      <a href="{{ url_for('download_market_prices') }}" class="download-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><path d="M19 9H15V3H9V9H5L12 16L19 9ZM5 18V20H19V18H5Z" fill="currentColor"/></svg> Download Full Dataset (CSV)</a>

      {% if chart_data %}
      <div class="chart-grid three-cols">
        <div class="chart-card">
          <h3><svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.5 18.49L9.5 12.49L13.5 16.49L22 6.92V20.5C22 21.05 21.55 21.5 21 21.5H3C2.45 21.5 2 21.05 2 20.5V18.49L3.5 18.49ZM21 4.5H3C2.45 4.5 2 4.95 2 5.5V7.51L3.5 7.51L9.5 13.51L13.5 9.51L21 1.92V4.5Z" fill="currentColor"/></svg> Price Trends Over Time</h3>
          <p class="chart-subtext">Multi-commodity line to spot trend reversals quickly.</p>
          <canvas id="lineChart"></canvas>
        </div>
        <div class="chart-card">
          <h3><svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z" fill="currentColor"/></svg> Average Price by Commodity</h3>
          <p class="chart-subtext">Benchmark commodities side-by-side for 2025.</p>
          <canvas id="barChart"></canvas>
        </div>
        <div class="chart-card">
          <h3><svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z" fill="currentColor"/><path d="M12 6C8.69 6 6 8.69 6 12C6 15.31 8.69 18 12 18C15.31 18 18 15.31 18 12C18 8.69 15.31 6 12 6Z" fill="currentColor"/></svg> Average Price Share</h3>
          <p class="chart-subtext">Quick read of each commodityâ€™s contribution.</p>
          <canvas id="dbPieChart"></canvas>
        </div>
      </div>
      {% else %}
      <p>No market price chart data available.</p>
      {% endif %}
    </div>

    <!-- NISR Dataset: only show title + charts (no data table) -->
    <button class="accordion"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V5H19V19ZM17 12H7V10H17V12ZM15 16H7V14H15V16ZM17 8H7V6H17V8Z" fill="currentColor"/></svg> NISR Dataset</button>
    <div class="panel">
      <p>This Dataset provides insights into the agricultural practices and outputs in Rwanda, with
        focusing on crop Production, yields, and related metrics for the year 2025. It is essential 
        for researchers studying agricultural trends, food security, and rural development in Rwanda.
      </p>
      <div class="nisr-title">This is the NISR dataset for crops (2025 Season A).</div>
      <p style="margin-top:10px;">You can download the full NISR XLSX and view the summary charts below.</p>
      <a href="{{ url_for('download_nisr_dataset') }}" class="download-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><path d="M19 9H15V3H9V9H5L12 16L19 9ZM5 18V20H19V18H5Z" fill="currentColor"/></svg> Download NISR Dataset (XLSX)</a>

      {% if nisr_chart_data %}
        <div class="chart-grid two-cols">
          <div class="chart-card">
            <h3><svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z" fill="currentColor"/></svg> NISR Average Prices</h3>
            <p class="chart-subtext">Mean price per crop, ordered from highest to lowest.</p>
            <canvas id="nisrBarChart"></canvas>
          </div>
          <div class="chart-card">
            <h3><svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.5 18.49L9.5 12.49L13.5 16.49L22 6.92V20.5C22 21.05 21.55 21.5 21 21.5H3C2.45 21.5 2 21.05 2 20.5V18.49L3.5 18.49ZM21 4.5H3C2.45 4.5 2 4.95 2 5.5V7.51L3.5 7.51L9.5 13.51L13.5 9.51L21 1.92V4.5Z" fill="currentColor"/></svg> Price Distribution</h3>
            <p class="chart-subtext">Histogram to see how frequently each price range appears.</p>
            <canvas id="nisrHistChart"></canvas>
          </div>
        </div>
      {% else %}
        <p style="margin-top:12px;">NISR dataset charts are not available (file missing or incorrect format).</p>
      {% endif %}

      <hr style="margin:24px 0; border: none; border-top:1px solid #eee;"/>
      <div class="nisr-title">Rwanda Maize Production (2025 vs 2024) by Province</div>
      <p style="margin-top:10px;">Maize Production in Rwanda has shown significant changes between
        2024 and 2025, with notable increases in several provinces due to improved agricultural 
        practices and favorable weather conditions. the charts bellow illustrate the Production
      </p>
      <a href="{{ url_for('download_maize_dataset') }}" class="download-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><path d="M19 9H15V3H9V9H5L12 16L19 9ZM5 18V20H19V18H5Z" fill="currentColor"/></svg> Download Maize Dataset (CSV)</a>

      {% if maize_data %}
        <div class="chart-container"><h3><svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><path d="M22 21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z" fill="currentColor"/></svg> Production by Province (2024 vs 2025)</h3><canvas id="maizeBarChart"></canvas></div>
        <div class="chart-container"><h3><svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><path d="M3.5 18.49L9.5 12.49L13.5 16.49L22 6.92V20.5C22 21.05 21.55 21.5 21 21.5H3C2.45 21.5 2 21.05 2 20.5V18.49L3.5 18.49ZM21 4.5H3C2.45 4.5 2 4.95 2 5.5V7.51L3.5 7.51L9.5 13.51L13.5 9.51L21 1.92V4.5Z" fill="currentColor"/></svg> Change Percentage Distribution (Histogram)</h3><canvas id="maizeHistChart"></canvas></div>
        <div class="chart-container"><h3><svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20Z" fill="currentColor"/><path d="M12 6C8.69 6 6 8.69 6 12C6 15.31 8.69 18 12 18C15.31 18 18 15.31 18 12C18 8.69 15.31 6 12 6Z" fill="currentColor"/></svg> 2025 Production Share by Province</h3><canvas id="maizePieChart"></canvas></div>
      {% else %}
        <p style="margin-top:12px;">Maize dataset is not available.</p>
      {% endif %}
    </div>

    <!-- Research Collaborations -->
    <button class="accordion"><svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;"><path d="M15.5 14H14.71L14.43 13.73C15.41 12.59 16 11.11 16 9.5C16 5.91 13.09 3 9.5 3C5.91 3 3 5.91 3 9.5C3 13.09 5.91 16 9.5 16C11.11 16 12.59 15.41 13.73 14.43L14 14.71V15.5L19 20.49L20.49 19L15.5 14ZM9.5 14C7.01 14 5 11.99 5 9.5C5 7.01 7.01 5 9.5 5C11.99 5 14 7.01 14 9.5C14 11.99 11.99 14 9.5 14Z" fill="currentColor"/></svg> Research Collaborations</button>
    <div class="panel">
      <h2>Soil Health Improvement Project</h2>
      <p>- Collaboration with universities and NGOs.</p>
      <p>- Focus: Sustainable soil fertility & productivity.</p>
    </div>

    <!-- Policy Briefs -->
    <button class="accordion">ðŸ“¢ Policy Briefs</button>
    <div class="panel">
      <h2>Climate-Smart Agriculture Policy</h2>
      <p>- Input on irrigation, pest management, and seed resilience.</p>
    </div>

  </div>

  <script>
    // Accordion toggle (only one opened)
    const acc = document.getElementsByClassName("accordion");
    for (let i = 0; i < acc.length; i++) {
      acc[i].addEventListener("click", function() {
        for (let j = 0; j < acc.length; j++) {
          if (acc[j] !== this) {
            acc[j].classList.remove("active");
            acc[j].nextElementSibling.style.display = "none";
          }
        }
        this.classList.toggle("active");
        const panel = this.nextElementSibling;
        panel.style.display = (panel.style.display === "block") ? "none" : "block";
      });
    }

    // DB charts (chart_data)
    {% if chart_data %}
    const dbPrices = {{ chart_data|tojson }};
    const lineCtx = document.getElementById('lineChart').getContext('2d');
    const accentPalette = ['#1E88E5','#43A047','#F4511E','#8E24AA','#00ACC1','#FB8C00','#6D4C41','#3949AB','#E53935'];
    new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: dbPrices.dates,
        datasets: Object.keys(dbPrices.commodities).map(function(c, idx) {
          return {
            label: c,
            data: dbPrices.commodities[c],
            borderWidth: 2,
            fill: false,
            tension: 0.35,
            borderColor: accentPalette[idx % accentPalette.length],
            backgroundColor: accentPalette[idx % accentPalette.length] + '33',
            pointRadius: 3,
            pointHoverRadius: 4
          };
        })
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        interaction: { mode: 'index', intersect: false },
        scales: {
          y: { beginAtZero: false, grid: { color: 'rgba(2,43,22,0.08)' } },
          x: { grid: { display: false } }
        }
      }
    });

    new Chart(document.getElementById('barChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: Object.keys(dbPrices.avg_prices),
        datasets: [{
          label: 'Average Price (DB)',
          data: Object.values(dbPrices.avg_prices),
          backgroundColor: '#283593',
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { color: 'rgba(2,43,22,0.08)' } },
          x: { grid: { display: false } }
        }
      }
    });

    // Pie chart for average prices share by commodity
    (function(){
      var labels = Object.keys(dbPrices.avg_prices);
      var values = Object.values(dbPrices.avg_prices);
      var colors = ['#1e88e5','#43a047','#f4511e','#8e24aa','#fdd835','#5e35b1','#00acc1','#fb8c00','#6d4c41','#00897b','#3949ab'];
      new Chart(document.getElementById('dbPieChart').getContext('2d'), {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{ data: values, backgroundColor: labels.map(function(_, i){ return colors[i % colors.length]; }) }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
      });
    })();
    {% endif %}

    // NISR charts (nisr_chart_data) - bar + histogram
    {% if nisr_chart_data %}
    const nisr = {{ nisr_chart_data|tojson }};

    new Chart(document.getElementById('nisrBarChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: nisr.commodities,
        datasets: [{
          label: 'NISR Avg Price',
          data: nisr.avg_prices,
          backgroundColor: '#1a237e',
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { color: 'rgba(2,43,22,0.08)' } },
          x: { grid: { display: false } }
        }
      }
    });

    new Chart(document.getElementById('nisrHistChart').getContext('2d'), {
      type: 'bar',
      data: {
        labels: nisr.histogram_bins,
        datasets: [{
          label: 'Record count',
          data: nisr.histogram_counts,
          backgroundColor: '#4caf50',
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { color: 'rgba(2,43,22,0.08)' } },
          x: { grid: { display: false } }
        }
      }
    });
    {% endif %}

    // Maize charts (maize_data) - grouped bar, histogram, pie
    {% if maize_data %}
    const maize = {{ maize_data|tojson }};

    // Grouped bar: 2024 vs 2025 by province
    new Chart(document.getElementById('maizeBarChart'), {
      type: 'bar',
      data: {
        labels: maize.provinces,
        datasets: [
          { label: '2024 Production (MT)', data: maize.prod_2024, backgroundColor: '#90caf9' },
          { label: '2025 Production (MT)', data: maize.prod_2025, backgroundColor: '#1e88e5' }
        ]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
    });

    // Histogram: Change % distribution across districts
    if (maize.histogram_bins && maize.histogram_counts) {
      new Chart(document.getElementById('maizeHistChart'), {
        type: 'bar',
        data: { labels: maize.histogram_bins, datasets: [{ label: 'District Count', data: maize.histogram_counts, backgroundColor: '#43a047' }] },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    // Pie: 2025 share by province
    const pieColors = ['#1e88e5', '#43a047', '#f4511e', '#8e24aa', '#fdd835', '#5e35b1', '#00acc1', '#fb8c00'];
    new Chart(document.getElementById('maizePieChart'), {
      type: 'pie',
      data: {
        labels: maize.provinces,
        datasets: [{ data: maize.prod_2025, backgroundColor: maize.provinces.map(function(label, i) { return pieColors[i % pieColors.length]; }) }]
      },
      options: { responsive: true }
    });
    {% endif %}
  </script>
  <script>
    function showToast(msg){
      var t=document.createElement('div');
      t.style.position='fixed';t.style.right='20px';t.style.bottom='20px';t.style.background='rgba(0,0,0,0.85)';
      t.style.color='#fff';t.style.padding='10px 14px';t.style.borderRadius='6px';t.style.fontSize='14px';
      t.style.boxShadow='0 2px 6px rgba(0,0,0,0.2)';t.style.opacity='0';t.style.transform='translateY(10px)';
      t.style.transition='opacity .25s ease, transform .25s ease';t.textContent=msg;document.body.appendChild(t);
      requestAnimationFrame(function(){t.style.opacity='1';t.style.transform='translateY(0)';});
      setTimeout(function(){t.style.opacity='0';t.style.transform='translateY(10px)'; setTimeout(function(){t.remove();},250);},2500);
    }
    // Toast when toggling accordion sections
    document.querySelectorAll('.accordion').forEach(function(btn){
      btn.addEventListener('click', function(){ showToast('Toggled: ' + (btn.textContent || 'Section')); });
    });
  </script>
  <script src="{{ url_for('static', filename='weather.js') }}"></script>
</body>
</html>
